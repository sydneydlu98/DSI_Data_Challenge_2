---
title: "DSI_Data_Challenge"
author: "Dingxin Lu"
date: "10/10/2021"
output:
  html_document:
    toc: true
    toc_float: true
---
[my github link] https://github.com/sydneydlu98/DSI_Data_Challenge_2

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Prep* 
```{r, message=FALSE}
# load all the packages
library(here)
library(readxl)
library(dplyr)
library(tidyverse)
library(janitor)
library(lubridate) 
library(tidyr)
library(stringr)
library(readr)
library(hrbrthemes)
```

## Problem 1

**We will be working with data from Mr. Trash Wheel, a water wheel trash collection device that removed trash from the Inner Harbor in Baltimore, Maryland. There are three trash wheels we will be exploring (Mr. Trash Wheel, Professor Trash Wheel, and Captain Trash Wheel). I have provided you the data for this on Canvas in the Excel spreadsheet titled Trash-Wheel-Collection-Totals-8-6-19.xlsx.**

```{r, message=FALSE}
# Read in the data from each of the three trash wheels sheets
mr_trash_wheel <- read_excel("Data/Trash-Wheel-Collection-Totals-8-6-19.xlsx", 
    sheet = "Mr. Trash Wheel") 

professor_trash_wheel <- read_excel("Data/Trash-Wheel-Collection-Totals-8-6-19.xlsx", 
    sheet = "Professor Trash Wheel")

captain_trash_wheel <- read_excel("Data/Trash-Wheel-Collection-Totals-8-6-19.xlsx", 
    sheet = "Captain Trash Wheel")

# Create a data wrangling function
data_wrangling <- function(data, name) {
  data %>%
    clean_names() %>%
    filter(is.na(dumpster) == FALSE) %>%
    select(dumpster:homes_powered) %>%
    mutate(wheel = name) %>%
    select(-dumpster, 
           -month, 
           -year, 
           -weight_tons, 
           -volume_cubic_yards, 
           -homes_powered)
}
 
## Perform the operations for the data
mr_trash_wheel_clean <- data_wrangling(mr_trash_wheel, 
                                       "Mr. Trash Wheel")
professor_trash_wheel_clean <- data_wrangling(professor_trash_wheel,
                                              "Professor Trash Wheel")
captain_trash_wheel_clean <- data_wrangling(captain_trash_wheel,
                                            "Captain Trash Wheel")
  
## bind the three data frames together into a data frame
all_trash_wheels <- bind_rows(mr_trash_wheel_clean,
                              professor_trash_wheel_clean,
                              captain_trash_wheel_clean)

## Pivot all_trash_wheels to long format with variables for trash_type and number of each trash type
all_trash_wheels_clean <- all_trash_wheels %>%
  pivot_longer(col = -c(date, wheel),
               names_to = 'trash_type', 
               values_to = 'number')

## format the column trash_type for plotting
all_trash_wheels_clean$trash_type <- all_trash_wheels_clean$trash_type %>%
  str_replace("_", " ") %>%
  str_to_title()

## create a new data frame for June 2018
all_trash_wheels_June_2018 <- all_trash_wheels_clean %>%
  filter(year(date) == 2018 & month(date) == 6) %>%
  group_by(wheel, 
           trash_type) %>%
  summarise(total_amount_trash = sum(number, 
                                     na.rm = TRUE))

## Make a faceted bar plot
all_trash_wheels_June_2018 %>%
  ggplot(aes(x = total_amount_trash,
             y = wheel)) +
  geom_bar(stat = "identity",
           aes(fill = wheel)) +
  facet_wrap(~trash_type, nrow = 4) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.y = element_blank(),
        legend.position = "bottom") +
  labs(x ='Amount of trash',
       y ='',
       fill = "Wheel:",
       title ='Amount of each type of trash collected by each wheel')
```

## Problem 2

**Next we will be examining data from FiveThirtyEight on the S&P closing prices and the unemployment rate. For this problem, the data is provided on Canvas. You will need snp.csv and unemployment.csv.**
```{r, warning=FALSE, message=FALSE}
## load both data
snp <- read_csv("Data/snp.csv")
unemployment <- read_csv("Data/unemployment.csv")


snp_clean <- snp %>%
  mutate(date = as_date(mdy(date))) %>%
  mutate(date = if_else(date > "2050-01-01",
                        date %m-% years(100),
                        date)) %>%
  mutate(year = year(date)) %>%
  mutate(month = month(date, 
                       label=TRUE))

unemployment_clean <- unemployment %>%
  pivot_longer(col = c(Jan:Dec),
               names_to = "Month", 
               values_to = "unemployment_rate") %>%
  mutate(date = mdy(paste(Month, "-01-", Year)))

## build joined data
combined_data <- inner_join(snp_clean, unemployment_clean, by = c('date'='date'))

coeff <- 200
ggplot(combined_data, aes(x = date)) +
  geom_line(aes(y = unemployment_rate), size = 1.5, color = "black") + 
  geom_line(aes(y = close / coeff), size = 1.5, color = "blue") + 
  scale_y_continuous(
    name = "Unemployment rate",
    sec.axis = sec_axis( trans = ~.*coeff, name="S&P closing price ($)") ## build a second Y axis
  ) +
  theme_ipsum() +
  theme(
    axis.title.y = element_text(color = "black", size=13),
    axis.title.y.right = element_text(color = "blue", size=13)
  ) +
  ggtitle("S&P closing price versus the unemployment rate")
```

## Problem 3

**Next we will examine the direct relationship between the S&P closing prices and the unemployment rate using data from 2000 and onward in a scatter plot.**
```{r, warning=FALSE, message=FALSE}
snp_average <- snp_clean %>%
  group_by(year, month) %>%
  summarise(mean_price = mean(close)) %>%
  mutate(date = mdy(paste(month, "-01-", year)))

data <- inner_join(snp_average, unemployment_clean)

data_updated <- data %>%
  filter(year >= 2010)

coeff <- 500
ggplot(data_updated, aes(x = date)) +
  geom_line(aes(y = unemployment_rate), size = 1.5, color = "black") + 
  geom_line(aes(y = mean_price / coeff), size = 1.5, color = "blue") + 
  scale_y_continuous(
    name = "Unemployment rate",
    sec.axis = sec_axis(trans = ~.*coeff, name="S&P closing price ($)") ## build a second Y axis
  ) +
  theme_ipsum() +
  theme(
    axis.title.y = element_text(color = "black", size=13),
    axis.title.y.right = element_text(color = "blue", size=13)
  ) +
  ggtitle("S&P closing price versus the unemployment rate in the year 2015")
```

## Problem 4

**Write a paragraph (at least 5 sentences) describing what you observed in the plots in Problems 2 & 3.**

